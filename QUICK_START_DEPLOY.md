# Quick Start: Deploy to AWS App Runner

This is a condensed version of the deployment process. For detailed instructions, see [DEPLOY_WALKTHROUGH.md](./DEPLOY_WALKTHROUGH.md).

## üöÄ Quick Deployment (5 Minutes)

### Step 1: Run Quick Deploy Script

```bash
cd backend
./quick-deploy.sh
```

This script will:
- ‚úÖ Check prerequisites (AWS CLI, Docker)
- ‚úÖ Create ECR repository
- ‚úÖ Build Docker image
- ‚úÖ Push to ECR
- ‚úÖ Generate secret key

### Step 2: Create IAM Roles (One-Time Setup)

```bash
# Get your AWS account ID
export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

# Create ECR Access Role
aws iam create-role \
    --role-name AppRunnerECRAccessRole \
    --assume-role-policy-document '{
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Principal": {"Service": "build.apprunner.amazonaws.com"},
        "Action": "sts:AssumeRole"
      }]
    }' 2>/dev/null || echo "Role already exists"

aws iam attach-role-policy \
    --role-name AppRunnerECRAccessRole \
    --policy-arn arn:aws:iam::aws:policy/service-role/AWSAppRunnerServicePolicyForECRAccess

# Create Instance Role
aws iam create-role \
    --role-name AppRunnerInstanceRole \
    --assume-role-policy-document '{
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Principal": {"Service": "tasks.apprunner.amazonaws.com"},
        "Action": "sts:AssumeRole"
      }]
    }' 2>/dev/null || echo "Role already exists"

# Attach DynamoDB policy
aws iam put-role-policy \
    --role-name AppRunnerInstanceRole \
    --policy-name DynamoDBAccess \
    --policy-document '{
      "Version": "2012-10-17",
      "Statement": [{
        "Effect": "Allow",
        "Action": [
          "dynamodb:PutItem",
          "dynamodb:GetItem",
          "dynamodb:UpdateItem",
          "dynamodb:DeleteItem",
          "dynamodb:Query",
          "dynamodb:Scan",
          "dynamodb:BatchGetItem",
          "dynamodb:BatchWriteItem",
          "dynamodb:DescribeTable",
          "dynamodb:CreateTable"
        ],
        "Resource": [
          "arn:aws:dynamodb:us-east-1:*:table/time_tracking_*",
          "arn:aws:dynamodb:us-east-1:*:table/time_tracking_*/index/*"
        ]
      }]
    }'
```

### Step 3: Create App Runner Service

1. Go to [AWS App Runner Console](https://console.aws.amazon.com/apprunner/)
2. Click **"Create service"**
3. Select **"Container registry"** ‚Üí **"Amazon ECR"**
4. Select repository: `time-tracking-backend`
5. Configure:
   - **Service name**: `time-tracking-backend`
   - **CPU**: 1 vCPU
   - **Memory**: 2 GB
   - **Port**: 8000
6. Add environment variables:
   - `SECRET_KEY` = (from quick-deploy.sh output)
   - `ENVIRONMENT` = `production`
   - `AWS_REGION` = `us-east-1`
7. Set IAM roles:
   - **Access role**: `AppRunnerECRAccessRole`
   - **Instance role**: `AppRunnerInstanceRole`
8. Click **"Create & deploy"**

### Step 4: Wait for Deployment

Wait 5-10 minutes for the service to deploy.

### Step 5: Test

```bash
# Get service URL from App Runner console
export SERVICE_URL="https://your-service-url.us-east-1.awsapprunner.com"

# Test health endpoint
curl $SERVICE_URL/health

# Test API
curl $SERVICE_URL/
```

## üìã Environment Variables Checklist

Required:
- [ ] `SECRET_KEY` - Generated by quick-deploy.sh
- [ ] `ENVIRONMENT` - Set to `production`
- [ ] `AWS_REGION` - Set to `us-east-1`

Optional (with defaults):
- [ ] `CORS_ORIGINS` - Your frontend URL
- [ ] `DYNAMODB_USERS_TABLE` - Default: `time_tracking_users`
- [ ] `DYNAMODB_TIMELOGS_TABLE` - Default: `time_tracking_logs`
- [ ] `DYNAMODB_AUDIT_TABLE` - Default: `time_tracking_audit`
- [ ] `DYNAMODB_HOLIDAYS_TABLE` - Default: `time_tracking_holidays`
- [ ] `DYNAMODB_LEAVE_REQUESTS_TABLE` - Default: `time_tracking_leave_requests`

## üéØ Default Admin User

On first startup, the app creates:
- **Email**: `admin@example.com`
- **Password**: `Admin123!`

**‚ö†Ô∏è Change this password immediately!**

## üí∞ Cost

- **App Runner**: ~$8/month
- **DynamoDB**: ~$0.70/month
- **S3 + CloudFront**: ~$0.90/month
- **Total**: ~$10-13/month

## üÜò Troubleshooting

### Service Won't Start
- Check CloudWatch logs
- Verify environment variables
- Check IAM roles

### Can't Connect to DynamoDB
- Verify IAM instance role has DynamoDB permissions
- Check AWS region
- Verify table names

### CORS Errors
- Update `CORS_ORIGINS` environment variable
- Restart service

## üìö Full Documentation

For detailed instructions, see:
- [DEPLOY_WALKTHROUGH.md](./DEPLOY_WALKTHROUGH.md) - Complete walkthrough
- [backend/DEPLOYMENT.md](./backend/DEPLOYMENT.md) - Technical details
- [backend/README-APPRUNNER.md](./backend/README-APPRUNNER.md) - Quick reference

## ‚úÖ Deployment Checklist

- [ ] AWS CLI installed and configured
- [ ] Docker installed and running
- [ ] Quick deploy script run successfully
- [ ] IAM roles created
- [ ] App Runner service created
- [ ] Environment variables configured
- [ ] Service deployed and running
- [ ] Health endpoint tested
- [ ] Default admin user created
- [ ] Frontend updated with new API URL

---

**Ready to deploy?** Run `./quick-deploy.sh` and follow the steps above!

