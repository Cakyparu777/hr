services:
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: dynamodb-local
    ports:
      - "8001:8000"
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb"]
    # Healthcheck disabled - DynamoDB Local doesn't have HTTP endpoint
    # We'll rely on the backend to handle connection retries
    # healthcheck:
    #   test: ["CMD-SHELL", "echo 'DynamoDB Local'"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3

  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - SECRET_KEY=your-secret-key-change-in-production
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=dummy
      - AWS_SECRET_ACCESS_KEY=dummy
      - DYNAMODB_ENDPOINT_URL=http://dynamodb-local:8000
      - DYNAMODB_USERS_TABLE=time_tracking_users
      - DYNAMODB_TIMELOGS_TABLE=time_tracking_logs
      - DYNAMODB_AUDIT_TABLE=time_tracking_audit
      - DYNAMODB_HOLIDAYS_TABLE=time_tracking_holidays
      - ENVIRONMENT=development
      - RATE_LIMIT_ENABLED=false
    volumes:
      - ./backend:/app
      - /app/venv  # Preserve venv if it exists
    command: ./start.sh
    depends_on:
      dynamodb-local:
        condition: service_started

  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      # Don't set REACT_APP_API_URL - let proxy handle it
      - DOCKER_ENV=true
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
      - FAST_REFRESH=true
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      backend:
        condition: service_started

